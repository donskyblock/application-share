# Alpine Linux based Dockerfile for Application Share
FROM alpine:latest

# Install dependencies
RUN apk add --no-cache \
    python3 \
    py3-pip \
    python3-dev \
    build-base \
    linux-headers \
    x11vnc \
    fluxbox \
    firefox \
    chromium \
    libreoffice \
    gimp \
    vlc \
    filezilla \
    thunderbird \
    geany \
    nano \
    htop \
    curl \
    wget \
    git \
    sudo \
    dbus \
    ttf-dejavu \
    ttf-liberation \
    font-noto \
    mesa-dri-gallium \
    mesa-gl \
    x11-utils \
    xauth \
    xinit

# Install optional packages with fallbacks
RUN if apk search -q xvfb &>/dev/null; then \
        apk add --no-cache xvfb; \
    elif apk search -q xvfb-run &>/dev/null; then \
        apk add --no-cache xvfb-run; \
    else \
        echo "xvfb not available, will use xvfb-run from x11-utils"; \
    fi

RUN if apk search -q xrdp &>/dev/null; then \
        apk add --no-cache xrdp; \
    elif apk search -q freerdp &>/dev/null; then \
        apk add --no-cache freerdp; \
    else \
        echo "xrdp not available, RDP functionality will be limited"; \
    fi

RUN if apk search -q neofetch &>/dev/null; then \
        apk add --no-cache neofetch; \
    elif apk search -q fastfetch &>/dev/null; then \
        apk add --no-cache fastfetch; \
    else \
        echo "neofetch not available, using basic system info"; \
    fi

# Create app user
RUN adduser -D -s /bin/bash appuser && \
    echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set working directory
WORKDIR /app

# Install Python packages
RUN pip3 install --upgrade pip && \
    pip3 install fastapi uvicorn python-socketio python-multipart python-dotenv passlib python-jose websockets pillow opencv-python-headless numpy psutil pydantic httpx aiofiles jinja2

# Copy application code
COPY . .

# Create a simple static frontend
RUN mkdir -p /app/static && \
    echo '<!DOCTYPE html><html><head><title>Application Share</title><meta charset="utf-8"></head><body><h1>Application Share</h1><p>Remote desktop access is ready!</p></body></html>' > /app/static/index.html

# Create startup script
RUN echo '#!/bin/bash\n\
echo "ðŸš€ Starting Application Share on Alpine Linux..."\n\
echo "ðŸ–¥ï¸  Starting virtual display..."\n\
Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &\n\
sleep 2\n\
echo "ðŸªŸ Starting window manager..."\n\
DISPLAY=:99 fluxbox &\n\
sleep 2\n\
echo "â³ Waiting for display to be ready..."\n\
while ! xdpyinfo -display :99 >/dev/null 2>&1; do\n\
    sleep 1\n\
done\n\
echo "âœ… Display is ready"\n\
echo "ðŸ“ Creating .env file..."\n\
cat > /app/.env << EOF\n\
PORT=3000\n\
DISPLAY=:99\n\
ADMIN_USERNAME=admin\n\
ADMIN_PASSWORD=${ADMIN_PASSWORD:-yourpassword123}\n\
VNC_ENABLED=false\n\
EOF\n\
echo "ðŸ”§ Configuration:"\n\
echo "   Port: 3000"\n\
echo "   Display: :99"\n\
echo "   Admin Username: admin"\n\
echo "   Admin Password: ${ADMIN_PASSWORD:-yourpassword123}"\n\
echo "   VNC Enabled: false"\n\
echo "ðŸ Starting Application Share server..."\n\
cd /app && python3 main.py\n\
' > /start.sh && chmod +x /start.sh

# Switch to app user
USER appuser

# Expose ports
EXPOSE 3000 5900 3389

# Start the application
CMD ["/start.sh"]

# Arch Linux based Dockerfile for Application Share
FROM archlinux:latest

# Update system and install dependencies
RUN pacman -Syu --noconfirm && \
    pacman -S --noconfirm \
    python \
    python-pip \
    python-virtualenv \
    xorg-server \
    xorg-xinit \
    xorg-xrandr \
    xorg-xdpyinfo \
    fluxbox \
    x11vnc \
    firefox \
    chromium \
    libreoffice \
    gimp \
    vlc \
    filezilla \
    thunderbird \
    geany \
    nano \
    htop \
    curl \
    wget \
    git \
    sudo \
    dbus \
    ttf-dejavu \
    ttf-liberation \
    noto-fonts \
    && pacman -Scc --noconfirm

# Install optional packages with fallbacks
RUN if pacman -Si xorg-server-xvfb &>/dev/null; then \
        pacman -S --noconfirm xorg-server-xvfb; \
    elif pacman -Si xvfb &>/dev/null; then \
        pacman -S --noconfirm xvfb; \
    else \
        echo "xvfb not available, will use xvfb-run from xorg-server"; \
    fi

RUN if pacman -Si xrdp &>/dev/null; then \
        pacman -S --noconfirm xrdp; \
    elif pacman -Si freerdp &>/dev/null; then \
        pacman -S --noconfirm freerdp; \
    else \
        echo "xrdp not available, RDP functionality will be limited"; \
    fi

RUN if pacman -Si neofetch &>/dev/null; then \
        pacman -S --noconfirm neofetch; \
    elif pacman -Si fastfetch &>/dev/null; then \
        pacman -S --noconfirm fastfetch; \
    else \
        echo "neofetch not available, using basic system info"; \
    fi

# Create app user
RUN useradd -m -s /bin/bash appuser && \
    echo "appuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set working directory
WORKDIR /app

# Install Python packages
RUN pip install --upgrade pip && \
    pip install fastapi uvicorn python-socketio python-multipart python-dotenv passlib python-jose websockets pillow opencv-python-headless numpy psutil pydantic httpx aiofiles jinja2

# Copy application code
COPY . .

# Create a simple static frontend
RUN mkdir -p /app/static && \
    echo '<!DOCTYPE html><html><head><title>Application Share</title><meta charset="utf-8"></head><body><h1>Application Share</h1><p>Remote desktop access is ready!</p></body></html>' > /app/static/index.html

# Create startup script
RUN echo '#!/bin/bash\n\
echo "🚀 Starting Application Share on Arch Linux..."\n\
echo "🖥️  Starting virtual display..."\n\
Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &\n\
sleep 2\n\
echo "🪟 Starting window manager..."\n\
DISPLAY=:99 fluxbox &\n\
sleep 2\n\
echo "⏳ Waiting for display to be ready..."\n\
while ! xdpyinfo -display :99 >/dev/null 2>&1; do\n\
    sleep 1\n\
done\n\
echo "✅ Display is ready"\n\
echo "📝 Creating .env file..."\n\
cat > /app/.env << EOF\n\
PORT=3000\n\
DISPLAY=:99\n\
ADMIN_USERNAME=admin\n\
ADMIN_PASSWORD=${ADMIN_PASSWORD:-yourpassword123}\n\
VNC_ENABLED=false\n\
EOF\n\
echo "🔧 Configuration:"\n\
echo "   Port: 3000"\n\
echo "   Display: :99"\n\
echo "   Admin Username: admin"\n\
echo "   Admin Password: ${ADMIN_PASSWORD:-yourpassword123}"\n\
echo "   VNC Enabled: false"\n\
echo "🐍 Starting Application Share server..."\n\
cd /app && python main.py\n\
' > /start.sh && chmod +x /start.sh

# Switch to app user
USER appuser

# Expose ports
EXPOSE 3000 5900 3389

# Start the application
CMD ["/start.sh"]
